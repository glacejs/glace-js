<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>GlaseJS Tutorial: Why GlaceJS suppresses uncaught exceptions</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.cosmo.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top ">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">GlaseJS</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="module-cli.html">cli</a></li><li><a href="module-globals.html">globals</a></li><li><a href="module-index.html">index</a></li><li><a href="module-run.html">run</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="tutorials.list.html" class="dropdown-toggle" data-toggle="dropdown">Tutorials<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="tutorial-conftest.html">How to use conftest.js</a></li><li><a href="tutorial-console-args.html">Command line arguments</a></li><li><a href="tutorial-middleware.html">How to use own middleware</a></li><li><a href="tutorial-reporter.html">How to use own reporter</a></li><li><a href="tutorial-uncaught.html">Why GlaceJS suppresses uncaught exceptions</a></li>
				</ul>
			</li>
			
		</ul>
        
            <div class="col-sm-3 col-md-3">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                        <div class="input-group-btn">
                            <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			<section class="tutorial-section">

<header>
    

    <h2>Why GlaceJS suppresses uncaught exceptions</h2>
</header>

<article>
    <p>Uncaught exceptions is really dangerous thing, that may break your <code>mochajs</code> tests queue.</p>
<p>Let's consider code example with async calls and uncaught exceptions.</p>
<pre class="prettyprint source lang-javascript"><code>/* sample.js */
var sleep = timeout => {
    return new Promise(resolve => {
        setTimeout(() => {
            console.log(`I was sleeping ${timeout} ms`);
            resolve();
        }, timeout);
    });
};

var error = timeout => {
    setTimeout(() => {
        throw new Error(&quot;BOOM!!!&quot;);
    }, timeout);
};

describe(&quot;scope&quot;, () => {
    it (&quot;test #1&quot;, async () => {
        error(1000);
        await sleep(1000);
    });
    it (&quot;test #2&quot;, async () => await sleep(1000));
    it (&quot;test #3&quot;, async () => {
        error(1000);
        await sleep(1000);
    });
    it (&quot;test #4&quot;, async () => await sleep(1000));
    it (&quot;test #5&quot;, async () => await sleep(1000));
    it (&quot;test #6&quot;, async () => await sleep(1000));
});</code></pre><p>Execute it and get something really strange in report:</p>
<pre class="prettyprint source"><code>$ mocha sample.js


  scope
    1) test #1  # in console it colored as red (failed)
I was sleeping 1000 ms
    √ test #1 (1012ms)
    2) test #3  # in console it colored as red (failed)
I was sleeping 1000 ms
I was sleeping 1000 ms
    √ test #4
    √ test #4
I was sleeping 1000 ms
I was sleeping 1000 ms
I was sleeping 1000 ms
    √ test #6 (1002ms)
    √ test #6 (1002ms)
    √ test #6 (1003ms)

  6 passing (3s)
  2 failing

  1) scope
       test #1:
     Uncaught Error: BOOM!!!
      at Timeout.setTimeout [as _onTimeout] (proba.js:12:15)

  2) scope
       test #3:
     Uncaught Error: BOOM!!!
      at Timeout.setTimeout [as _onTimeout] (proba.js:12:15)





  6 passing (3s)
  2 failing

  1) scope
       test #1:
     Uncaught Error: BOOM!!!
      at Timeout.setTimeout [as _onTimeout] (proba.js:12:15)

  2) scope
       test #3:
     Uncaught Error: BOOM!!!
      at Timeout.setTimeout [as _onTimeout] (proba.js:12:15)




  6 passing (3s)
  2 failing

  1) scope
       test #1:
     Uncaught Error: BOOM!!!
      at Timeout.setTimeout [as _onTimeout] (proba.js:12:15)

  2) scope
       test #3:
     Uncaught Error: BOOM!!!
      at Timeout.setTimeout [as _onTimeout] (proba.js:12:15</code></pre><ol>
<li>Pay attention, that <code>test #1</code> is mentioned twice: as passed and as failed!</li>
<li><code>test #2</code> &amp; <code>test #5</code> are absent in report!</li>
<li>You may see concurrent printing of messages <code>I was sleeping 1000 ms</code>, 1 time, 2 times, 3 times.</li>
</ol>
<p>Let's see why it happens.
The problem, that by default <code>mochajs</code> processes <code>uncaught exceptions</code>: https://github.com/mochajs/mocha/blob/master/lib/runner.js#L698. And if such exception happens, <code>mochajs</code> fails currently executed test. And it doesn't matter whether such exception happens in current test or was born many tests ago (due to unstopped timer, for example). This processing is implemented via listener, and in above example very interesting things happen:</p>
<ol>
<li>In <code>test #1</code> on one hand <code>uncaught exception</code> happens after 1 second and its processing starts. On the other hand, <code>test #1</code> waits for <code>sleep</code> finishing 1 second and then <code>mochajs</code> marks it as passed.</li>
<li>Due to async of <code>JavaScript</code>, there are two concurrently <code>test #1</code> processors, that leads to <code>test #1</code> reporting twice.</li>
<li>More over, since there are two places, which emit events to start new test execution. And factically, there are two tests queues.</li>
<li>In <code>test #3</code> previous situation repeats. And there are 3 concurrently executed tests queues! The evidence is a number of printed messages <code>I was sleeping 1000 ms</code>.</li>
</ol>
<p><strong>How to fix</strong></p>
<p>Simple and working variant is to suppress <code>uncaught exception</code>.</p>
<pre class="prettyprint source lang-javascript"><code>var Mocha = require(&quot;mocha&quot;);
Mocha.Runner.prototype.uncaught = function (err) {
    logger.error(&quot;UNCAUGHT ERROR&quot;, err);
};</code></pre><p>It's better to get one failed test and in test finalizers to close all descriptors, to stop proxies, to kill processes and so on, than to get fully failed tests queue in nightly build.</p>
<p>That's why mechanism to suppress <code>uncaught exceptions</code> is enabled by default in <code>GlaceJS</code>. But it may be disabled with option <code>--allow-uncaught</code>.</p>
</article>

</section>

		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


    <div class="modal fade" id="searchResults">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Search results</h4>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>


<footer>


	<span class="copyright">
	Copyright 2017
	</span>

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a>
	
		on 2018-07-19T08:24:30+03:00
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>

    <script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>


<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre, pre.prettyprint.source" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->



    <script type="text/javascript">
        $(document).ready(function() {
            SearcherDisplay.init();
        });
    </script>


</body>
</html>